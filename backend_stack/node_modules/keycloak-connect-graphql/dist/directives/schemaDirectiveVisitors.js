"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.HasPermissionDirective = exports.HasRoleDirective = exports.AuthDirective = void 0;
const graphql_1 = require("graphql");
const utils_1 = require("@graphql-tools/utils");
const directiveResolvers_1 = require("./directiveResolvers");
class AuthDirective extends utils_1.SchemaDirectiveVisitor {
    constructor(config) {
        super(config);
    }
    visitFieldDefinition(field) {
        const { resolve = graphql_1.defaultFieldResolver } = field;
        field.resolve = directiveResolvers_1.auth(resolve);
    }
}
exports.AuthDirective = AuthDirective;
class HasRoleDirective extends utils_1.SchemaDirectiveVisitor {
    constructor(config) {
        super(config);
    }
    visitFieldDefinition(field) {
        const { resolve = graphql_1.defaultFieldResolver } = field;
        const roles = this.parseAndValidateArgs(this.args);
        field.resolve = directiveResolvers_1.hasRole(roles)(resolve);
    }
    /**
     *
     * validate a potential string or array of values
     * if an array is provided, cast all values to strings
     */
    parseAndValidateArgs(args) {
        const keys = Object.keys(args);
        if (keys.length === 1 && keys[0] === 'role') {
            const role = args[keys[0]];
            if (typeof role == 'string') {
                return [role];
            }
            else if (Array.isArray(role)) {
                return role.map(val => String(val));
            }
            else {
                throw new Error(`invalid hasRole args. role must be a String or an Array of Strings`);
            }
        }
        throw Error('invalid hasRole args. must contain only a \'role\ argument');
    }
}
exports.HasRoleDirective = HasRoleDirective;
class HasPermissionDirective extends utils_1.SchemaDirectiveVisitor {
    constructor(config) {
        super(config);
    }
    visitFieldDefinition(field) {
        const { resolve = graphql_1.defaultFieldResolver } = field;
        const resources = this.parseAndValidateArgs(this.args);
        field.resolve = directiveResolvers_1.hasPermission(resources)(resolve);
    }
    /**
     *
     * validate a potential string or array of values
     * if an array is provided, cast all values to strings
     */
    parseAndValidateArgs(args) {
        const keys = Object.keys(args);
        if (keys.length === 1 && keys[0] === 'resources') {
            const resources = args[keys[0]];
            if (typeof resources == 'string') {
                return [resources];
            }
            else if (Array.isArray(resources)) {
                return resources.map(val => String(val));
            }
            else {
                throw new Error(`invalid hasPermission args. resources must be a String or an Array of Strings`);
            }
        }
        throw Error('invalid hasPermission args. must contain only a \'resources\ argument');
    }
}
exports.HasPermissionDirective = HasPermissionDirective;
//# sourceMappingURL=schemaDirectiveVisitors.js.map